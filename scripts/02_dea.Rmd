---
title: "Analysis"
output: html_document
---

```{r library}
library(tidyverse)
library(data.table)

library(lubridate)

library(gganimate)
library(ggalluvial)
```

```{r reading}
day <- "24_04_2020"

df <- fread(paste0("./data/treated/deaths_br_", 
                   day,
                   "_by_gender_age_date_state.csv"))
```

```{r}
df <- df %>% 
  as_tibble() %>% 
  mutate(date = ymd(date))
```

# Graph 1 - Daily evolution in pyramid chart

Apparently we need to have all the data: 
https://purrr.tidyverse.org/reference/cross.html

```{r}
df_pyramid_all <- purrr::cross_df(.l = list(
  "state" = df %>% select(state) %>% unique() %>% pull(),
  "date" = df %>% select(date) %>% unique() %>% pull(),
  "gender" = df %>% select(gender) %>% unique() %>% pull(),
  "age_group" = df %>% select(age_group) %>% unique() %>% pull()))

df_pyramid_all <- df_pyramid_all %>% 
  mutate(date = lubridate::as_date(date))
```

```{r}
df_pyramid_all <- df_pyramid_all %>% 
  left_join(df, by = c("state", "date", "age_group", "gender")) %>% 
  mutate(number_deaths = ifelse(is.na(number_deaths), 0, number_deaths))
```

```{r}
age_group_levels <- df_pyramid_all %>% pull(age_group) %>% unique() %>% sort()
age_group_levels[1] <- "< 9"
age_group_levels[10] <- age_group_levels[11]
age_group_levels[11] <- "> 100"

df_pyramid_all_cumulative_deaths <- df_pyramid_all %>% 
  mutate(age_group = factor(age_group, levels = age_group_levels)) %>% 
  arrange(state, age_group, gender, date) %>% 
  group_by(state, age_group, gender) %>% 
  mutate(number_deaths_cum = cumsum(number_deaths))
```

```{r}
g1 <- df_pyramid_all_cumulative_deaths %>% 
  mutate(number_deaths_cum = ifelse(gender == "F", -number_deaths_cum, number_deaths_cum)) %>% 
  filter(date <= dmy("24/04/2020") & date <= dmy("21/04/2020")) %>% 
  ggplot(aes(x = age_group, y = number_deaths_cum)) +
  geom_col(aes(fill = gender)) +
  coord_flip() +
  facet_wrap(~state) +
  # Here comes the gganimate specific bits
  labs(title = 'Date: {frame_time}', x = 'Age group', y = '# of Deaths') +
  transition_time(date)
  #ease_aes('linear')

animate(g1, renderer = gifski_renderer())
```

# Graph 2 - Daily evolution in a map

```{r}

```

